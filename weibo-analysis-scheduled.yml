name: Weibo Analysis - Scheduled (Beijing Time 6AM & 6PM)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹ = UTC 22ç‚¹ï¼ˆå‰ä¸€å¤©ï¼‰
    - cron: "0 22 * * *"
    # åŒ—äº¬æ—¶é—´æ™šä¸Š6ç‚¹ = UTC 10ç‚¹
    - cron: "0 10 * * *"
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™ä»¥ä¾¿æäº¤æŠ¥å‘Š

jobs:
  weibo-hotspot-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install claude-agent-sdk anthropic anyio httpx requests

      - name: Create resources directory
        run: |
          mkdir -p resources
          echo "Resources directory created"

      - name: Stage 1 - Fetch Weibo Hotspots
        env:
          TIANAPI_WEIBO_API_KEY: ${{ secrets.TIANAPI_WEIBO_API_KEY }}
        run: |
          echo "=== é˜¶æ®µ1: æŠ“å–å¾®åšçƒ­æœæ•°æ® ==="
          curl -G "https://apis.tianapi.com/weibohot/index" \
            --data-urlencode "key=$TIANAPI_WEIBO_API_KEY" \
            -o resources/weibo_hotspots_raw.json

          # éªŒè¯æ•°æ®æ˜¯å¦æˆåŠŸè·å–
          if [ -f resources/weibo_hotspots_raw.json ]; then
            echo "âœ… çƒ­æœæ•°æ®æŠ“å–æˆåŠŸ"
            # æ˜¾ç¤ºæ•°æ®åŸºæœ¬ä¿¡æ¯
            python -c "import json; data=json.load(open('resources/weibo_hotspots_raw.json')); print(f'æ•°æ®æ¡æ•°: {len(data.get(\"result\", {}).get(\"list\", []))}æ¡')"
          else
            echo "âŒ çƒ­æœæ•°æ®æŠ“å–å¤±è´¥"
            exit 1
          fi

      - name: Stage 1 - Parse and format data
        run: |
          echo "=== è§£æå’Œæ ¼å¼åŒ–æ•°æ® ==="
          python scripts/parse_hotspots.py
          python scripts/data_quality_check.py
          python scripts/get_top10.py

      - name: Stage 2 & 3 - Background Collection and Creative Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          TIAN_API_KEY: ${{ secrets.TIANAPI_WEIBO_API_KEY }}
        run: |
          echo "=== é˜¶æ®µ2: èƒŒæ™¯ä¿¡æ¯é‡‡é›† ==="
          echo "=== é˜¶æ®µ3: AIåˆ›æ„åˆ†æ ==="
          python scripts/ai_creative_analysis.py

      - name: Stage 3 - Creative Quality Report
        run: |
          echo "=== ç”Ÿæˆåˆ›æ„è´¨é‡æŠ¥å‘Š ==="
          python scripts/creative_quality_report.py

      - name: Stage 4 - Generate HTML Report
        run: |
          echo "=== é˜¶æ®µ4: ç”ŸæˆHTMLæŠ¥å‘Š ==="
          python scripts/generate_html_report.py

          # éªŒè¯HTMLæŠ¥å‘Šæ˜¯å¦ç”Ÿæˆ
          if ls resources/å¾®åšçƒ­æœåˆ†æ-*.html 1> /dev/null 2>&1; then
            echo "âœ… HTMLæŠ¥å‘Šç”ŸæˆæˆåŠŸ"
            ls -lh resources/å¾®åšçƒ­æœåˆ†æ-*.html
          else
            echo "âŒ HTMLæŠ¥å‘Šç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: Generate Summary with Claude Agent SDK
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "=== ä½¿ç”¨ Claude Agent SDK ç”Ÿæˆæ€»ç»“ ==="
          python - << "PYTHON_SCRIPT"
          import json
          from datetime import datetime
          import anyio
          from claude_agent_sdk import query

          # è¯»å–åˆ†æç»“æœ
          with open("resources/creative_analysis_results.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          results = data.get("results", [])
          hot_count = len(results)

          # ç»Ÿè®¡è¯„åˆ†åˆ†å¸ƒ
          excellent = sum(1 for r in results if r['scoring']['total_score'] >= 80)
          good = sum(1 for r in results if 60 <= r['scoring']['total_score'] < 80)
          normal = sum(1 for r in results if r['scoring']['total_score'] < 60)

          # æ‰¾å‡ºå¾—åˆ†æœ€é«˜çš„3ä¸ªè¯é¢˜
          top_3 = sorted(results, key=lambda x: x['scoring']['total_score'], reverse=True)[:3]

          today = datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")

          prompt = f"""ä»Šå¤©æ˜¯{today}ï¼Œæˆ‘å®Œæˆäº†å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†æã€‚

  åˆ†æç»“æœæ‘˜è¦ï¼š
  - å…±åˆ†æäº† {hot_count} æ¡çƒ­æœ
  - è¯„åˆ†åˆ†å¸ƒï¼šä¼˜ç§€({excellent}ä¸ª)ã€è‰¯å¥½({good}ä¸ª)ã€ä¸€èˆ¬({normal}ä¸ª)
  - TOP 3 è¯é¢˜ï¼š
    1. {top_3[0]['title']} (å¾—åˆ†: {top_3[0]['scoring']['total_score']:.1f})
    2. {top_3[1]['title']} (å¾—åˆ†: {top_3[1]['scoring']['total_score']:.1f})
    3. {top_3[2]['title']} (å¾—åˆ†: {top_3[2]['scoring']['total_score']:.1f})

  è¯·ç”¨ä¸­æ–‡ç”Ÿæˆä¸€æ®µä¸è¶…è¿‡300å­—çš„åˆ†ææ€»ç»“ï¼Œé‡ç‚¹è¯´æ˜ï¼š
  1. ä»Šæ—¥çƒ­æœçš„æ•´ä½“ç‰¹ç‚¹å’Œè¶‹åŠ¿
  2. æœ€å€¼å¾—å…³æ³¨çš„è¯é¢˜åŠå…¶äº§å“åˆ›æ„ä»·å€¼
  3. è¯„åˆ†åˆ†å¸ƒåæ˜ çš„å¸‚åœºæœºä¼š

  ä»¥JSONéƒ¨åˆ†å†…å®¹ä¸ºå‚è€ƒï¼š
  {json.dumps(top_3, ensure_ascii=False, indent=2)[:8000]}
  """

          async def generate_summary():
              print("æ­£åœ¨è°ƒç”¨ Claude Agent SDK ç”Ÿæˆæ€»ç»“...")
              summary = ""
              async for chunk in query(prompt=prompt):
                  summary += chunk

              print("\n=== Claude AI åˆ†ææ€»ç»“ ===")
              print(summary)
              print("=" * 60)

              # ä¿å­˜æ€»ç»“åˆ°æ–‡ä»¶
              with open("resources/analysis_summary.txt", "w", encoding="utf-8") as f:
                  f.write(f"å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææ€»ç»“ - {today}\n")
                  f.write("=" * 60 + "\n\n")
                  f.write(summary)

              print("âœ… åˆ†ææ€»ç»“å·²ä¿å­˜åˆ° resources/analysis_summary.txt")

          anyio.run(generate_summary)
          PYTHON_SCRIPT

      - name: Upload HTML report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: weibo-hotspot-report-${{ github.run_number }}
          path: |
            resources/å¾®åšçƒ­æœåˆ†æ-*.html
            resources/analysis_summary.txt
            resources/creative_analysis_results.json
          retention-days: 30

      - name: Commit and push results (optional)
        if: github.event_name == 'schedule'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add resources/å¾®åšçƒ­æœåˆ†æ-*.html
          git add resources/analysis_summary.txt
          git add resources/*.json

          # æäº¤ï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "chore: å¾®åšçƒ­æœåˆ†ææŠ¥å‘Š - $TIMESTAMP [skip ci]"
            git push
            echo "âœ… åˆ†æç»“æœå·²æäº¤åˆ°ä»“åº“"
          fi

      - name: Job Summary
        if: always()
        run: |
          echo "## å¾®åšçƒ­æœåˆ†ææ‰§è¡Œæ‘˜è¦ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC") (åŒ—äº¬æ—¶é—´: $(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S"))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f resources/creative_analysis_results.json ]; then
            echo "### åˆ†æç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            python - << "SUMMARY_SCRIPT"
          import json
          results = json.load(open('resources/creative_analysis_results.json'))['results']
          excellent = sum(1 for r in results if r['scoring']['total_score'] >= 80)
          good = sum(1 for r in results if 60 <= r['scoring']['total_score'] < 80)
          normal = sum(1 for r in results if r['scoring']['total_score'] < 60)
          print(f"- ğŸ“ˆ æ€»åˆ†ææ•°: {len(results)} æ¡çƒ­æœ")
          print(f"- â­ ä¼˜ç§€ (â‰¥80åˆ†): {excellent} ä¸ª")
          print(f"- âœ“ è‰¯å¥½ (60-80åˆ†): {good} ä¸ª")
          print(f"- âšª ä¸€èˆ¬ (<60åˆ†): {normal} ä¸ª")
          SUMMARY_SCRIPT
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ -f resources/analysis_summary.txt ]; then
              echo "### Claude AI åˆ†ææ€»ç»“" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              tail -n +3 resources/analysis_summary.txt >> $GITHUB_STEP_SUMMARY
            fi
          fi
